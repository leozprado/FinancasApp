@page "/consulta-categorias"

<div class="card m-4 shadow">
    <div class="card-body">

        <h4>Consulta de categorias</h4>
        <p>Listagem de categorias para movimentações financeiras.</p>
        <hr />

        <div class="mb-3">
            <NavLink href="/cadastro-categorias" class="btn btn-success btn-sm">
                Cadastrar categoria
            </NavLink>
        </div>

        @if (!string.IsNullOrEmpty(mensagem))
        {
            <div class="alert alert-primary">
                <strong>@mensagem</strong>
            </div>
        }

        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Nome da categoria</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in categorias)
                {
                    <tr>
                        <td>@item.nome.ToUpper()</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1"
                                    @onclick="(() => OnEdit(item.id))">
                                Editar
                            </button>
                            <button class="btn btn-sm btn-outline-danger me-1"
                                    @onclick="(() => OnDelete(item.id))">
                                Excluir
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="2">
                        Quantidade de categorias: @(categorias.Count)
                    </td>
                </tr>
            </tfoot>
        </table>

    </div>
</div>

@using FinancasApp.WEB.Models

@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

@code {

    //Declarando uma lista de categorias
    private List<CategoriaModel> categorias = new();

    //Declarando um atributo para guardar mensagens
    private string mensagem = string.Empty;

    //Evento executado pelo Blazor no momento em que o componente abrir
    protected override async Task OnInitializedAsync()
    {
        //Fazendo uma consulta de categorias na API
        categorias = await Http.GetFromJsonAsync<List<CategoriaModel>>
                        ("api/categorias") ?? new();
    }

    //Evento para excluir uma categoria selecionada no grid
    protected async Task OnDelete(Guid id)
    {
        mensagem = string.Empty;

        var confirm = await JS.InvokeAsync<bool>("confirm", "Deseja excluir esta categoria?");
        if (confirm) //verificar se a opção 'OK' foi clicada
        {
            //Fazendo a exclusão da categoria na API
            var response = await Http.DeleteAsync("api/categorias/" + id);
            if (response.IsSuccessStatusCode) //verificando se a exclusão foi realizada
            {
                mensagem = "Categoria excluída com sucesso.";
                await OnInitializedAsync(); //fazer uma nova consulta
            }
            else
            {
                mensagem = "Falha ao excluir a categoria.";
            }
        }
    }

    //Evento para navegar para a página de edição
    protected async Task OnEdit(Guid id)
    {
        //Navegar para a página de edição e enviar
        //o ID da categoria selecionada
        Navigation.NavigateTo("/edicao-categorias/" + id);
    }
}
